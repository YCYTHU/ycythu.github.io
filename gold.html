<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Gold</title>
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js">
</script>
</head>
<body>

</body>
<script>
$(function() {
    console.log('start operate');

    // 获取session
    getSession();

    // 主动报价
    initiativePrice();

    //var PM_Txn_Vrty_Cd = "23";

    // 定期报价
    //regularPrice(PM_Txn_Vrty_Cd);

    //var pageJump = "1";
    //var amount = "12";
    //var Hdl_InsID = "110000000";
    //var Org_Inst_Rgon_Cd = "BJ";
//
    //// 获取实物贵金属查询条件(post请求)
    //getPhysicalPreciousMetal(pageJump, amount, Hdl_InsID, Org_Inst_Rgon_Cd);
//
    //// 新闻资讯-综合推荐
    //newsInfoSynthesizeRecommend();
//
    //// 新闻资讯-贵金属资讯
    //newsInfoPhysicalPreciousInfo();
//
    console.log('end operate');
});

// 获取session查询条件
var getSessionCondition = {
    port: "https://gold.ccb.com/tran/WCCMainPlatV5?CCB_IBSVersion=V5&SERVLET_NAME=WCCMainPlatV5&TXCODE=100119",
    //port: "/tran/WCCMainPlatV5?CCB_IBSVersion=V5&SERVLET_NAME=WCCMainPlatV5&TXCODE=100119",
};

// 获取session(先行访问100119交易，拿到session，因为后续接口需要登录)
function getSession() {
    console.log('getSession');

    console.log('getSessionCondition:');
    console.log(getSessionCondition);
    console.log(getSessionCondition.port)

    var getSessionUrl = getAjaxSendUrl(getSessionCondition);
    
	getData(getSessionUrl).then(function (data) {
		console.log('getSession data:');
		console.log(data);
	}).catch(function (error) {
		console.log(error + "||catch error || ");
	})
}

// 主动报价查询条件
var initiativePriceCondition = {
    port: "https://gold.ccb.com/tran/WCCMainPlatV5?CCB_IBSVersion=V5&SERVLET_NAME=WCCMainPlatV5&TXCODE=NGJS01",
    //port: "/tran/WCCMainPlatV5?CCB_IBSVersion=V5&SERVLET_NAME=WCCMainPlatV5&TXCODE=NGJS01",
};
//window.setInterval(initiativePrice, 6000);
function initiativePrice() {
    console.log('initiativePrice');
    console.log('initiativePriceCondition:');
    console.log(initiativePriceCondition);
    
    var initiativePriceUrl = getAjaxSendUrl(initiativePriceCondition);

	getData(initiativePriceUrl).then(function (data) {
		console.log('initiativePrice data:');
		console.log(data);
		if (data.SUCCESS == "true") {
            console.log('initiativePrice success');
            // 开始处理主动报价页面
            console.log('start handle initiativePrice html');

            // 写入：主动积存价-客户买入价
            //$("#initiativeBuyPrice").html(data.Cst_Buy_Prc);
            
            // 写入：主动积存价-客户买入价
            //$("#initiativeSellPrice").html(data.Cst_Sell_Prc);
            
            // 获取时间，去掉时间后面的点
            var initiativeTms = data.Tms.split(".")[0];

            // 切割字符串，获取日期和时间
            var initiativeTmsArray = initiativeTms.split(" ");

            // 获取日期
            var initiativeDate = initiativeTmsArray[0];

            // 获取时间
            var initiativeTime = initiativeTmsArray[1];

            // 写入：日期
            //$("#initiativeDate").html(initiativeDate);

            // 写入：时间
            //$("#initiativeTime").html(initiativeTime);

            // 结束处理主动报价页面
            console.log('end handle initiativePrice html');
		} else if (data.SUCCESS == "false") {
            console.log('initiativePrice fail');
        }
	}).catch(function (error) {
		console.log(error + "||catch error || ");
	})
}

function getAjaxSendUrl(object) {
    var ajaxSendUrl = object.port;
    for (var key in object) {
        if (object.hasOwnProperty(key) && key != "port") {
            ajaxSendUrl += "&" + key + "=" + object[key];
        }
    }
    return ajaxSendUrl
}

function getData(url, dataType, callback) {
    dataType = dataType || "json";
    jsonpCallback = callback || "";
    return new Promise(function (resolve, reject) {
        $.ajax({
            url: url,
            dataType: dataType,
            jsonpCallback: jsonpCallback,
            success: function (data) {
                resolve(data)
            },
            error: function (err) {
                reject(err)
            }
        });
    })
}
</script>
</html>